CREATE DEFINER=`licencias`@`%` PROCEDURE `ins_turno_admi`(
IN `PMODULOID` INT, 
IN `PDIAID` INT, 
IN `PHORARIOID` INT, 
IN `PFECHA` DATE, 
IN `PTIPOTRAM` INT, 
IN `PNOMBRE` VARCHAR(300), 
IN `PCUI` VARCHAR(15), 
IN `PEMAIL` VARCHAR(180), 
IN `PTELEFONO` INT,
IN `PMOTIVO` VARCHAR(180),
IN `PUSUARIOID` INT,
IN `PFECHANAC` DATE )
BEGIN
    DECLARE MISMOTRAM 	INT DEFAULT 0;
    DECLARE VALIDACIONCANT	INT	DEFAULT 0;
    DECLARE VMESSAGE VARCHAR(200) DEFAULT ' ';
    DECLARE PCODIGO	INT	DEFAULT 0;
    DECLARE PMESSAGE VARCHAR(200) DEFAULT ' ';
    DECLARE VTURNOID INT DEFAULT 0;
    DECLARE VSEMANA INT DEFAULT 0;
    DECLARE VMODULOID INT DEFAULT 0;
    DECLARE VTOTAL INT DEFAULT 0;
    
    select count(1)
    INTO VSEMANA
	from turno
	where cui = PCUI
	and fecha between DATE_ADD(PFECHA, INTERVAL -7 DAY) and DATE_ADD(PFECHA , INTERVAL 7 DAY)
    AND ESTATUSID = 2;
    
    SELECT count(1)
    INTO MISMOTRAM
	FROM turno
	WHERE  FECHA = PFECHA
	AND CUI = PCUI
	AND ESTATUSID = 2;

    
    IF VSEMANA = 0 THEN
    IF MISMOTRAM = 0 THEN
		IF VALIDACIONCANT = 0 THEN
		
			SELECT IFNULL(PADREID,0)
				INTO VTOTAL
				FROM CAT_MODULO
                WHERE MODULOID = PMODULOID
                AND PFECHA BETWEEN FECHA_INICIAL AND FECHA_FINAL
                AND ESTATUSID = 2;
			
            IF (VTOTAL > 0) THEN
				SET VMODULOID = VTOTAL;
			ELSE
				SET VMODULOID = PMODULOID;
			END IF;
        
			INSERT INTO turno (	MODULOID,FECHA,HORARIOID,TIPO_TRAMITEID,NOMBRE,CUI,EMAIL,FECHAHORA_INGRESO,ESTATUSID,TELEFONO,FECHA_NACIMIENTO,DIRECCIONIP, ISADMIN, USUARIOCITAID)
			VALUES (VMODULOID,PFECHA,PHORARIOID,PTIPOTRAM,PNOMBRE,PCUI,PEMAIL,sysdate(),2,PTELEFONO,PFECHANAC,'1.1.1.1', 1, PUSUARIOID);
			
			SELECT MAX(TURNOID)
           INTO VTURNOID
           FROM turno
           WHERE ESTATUSID = 2;
            
            INSERT INTO motivo_turno
			(`TURNOID`,`DESCRIPCION`,`USUARIOID`,`FECHAHORA_INGRESO`,`ESTATUSID`)
			VALUES (VTURNOID,PMOTIVO,PUSUARIOID,sysdate(),2);
            
            SET PCODIGO = 0;
           
           
           SET VMESSAGE = VTURNOID;
		ELSE
			SET PCODIGO = -1;
			
		END IF;
	ELSE
    SET PCODIGO = -2;
    SET VMESSAGE = 'EL USUARIO YA POSEE UN TURNO PARA ESE TRAMITE EN LA FECHA SELECCIONADA';
    END IF;
    ELSE 
    SET PCODIGO = -3;
    SET VMESSAGE = 'EL USUARIO YA POSEE UN TURNO PARA LA SIGUIENTE SEMANA O SEMANA ANTERIOR';
    END IF;
    SET PMESSAGE = VMESSAGE;
    select PCODIGO, PMESSAGE ;
END
